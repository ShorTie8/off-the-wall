#! /bin/bash

device=`basename $1`

cd /sys/block

UDEVINFO="/sbin/udevadm info --path=${PWD}/${device} --query=all"
serial=`$UDEVINFO | grep ID_SERIAL_SHORT | sed -e 's/.*=//'`
if [ -z "$serial" ]; then
  # non-virtio disks
  [ -f "${device}/device/serial" ] && serial=`cat ${device}/device/serial 2>&1 | sed -e 's/ /-/g'`
  # virtio disks don't follow the custom
  [ -f "${device}/serial" ] && serial=`cat ${device}/serial 2>&1 | sed -e 's/ /-/g'`
fi
[ -z "$serial" ] && serial="UNK_SERIAL"


  (
    echo "# Smoothwall Express persistent device names"
    echo
    echo "# Auto-generated by installation program: `date`"
    
    echo "# hard drive's symlink"
    echo "SUBSYSTEM==\"block\",KERNEL==\"[hs]d*|cciss*\",ENV{DEVTYPE}==\"disk\",ENV{ID_SERIAL_SHORT}==\"${serial}\", SYMLINK+=\"harddisk\""
    echo "SUBSYSTEM==\"block\",KERNEL==\"[hs]d*|cciss*\",ENV{DEVTYPE}==\"partition\",ENV{ID_SERIAL_SHORT}==\"${serial}\", SYMLINK+=\"harddisk%n\""
    echo "SUBSYSTEM==\"block\",KERNEL==\"vd*\",ENV{DEVTYPE}==\"disk\",ENV{ID_SERIAL}==\"${serial}\", SYMLINK+=\"harddisk\""
    echo "SUBSYSTEM==\"block\",KERNEL==\"vd*\",ENV{DEVTYPE}==\"partition\",ENV{ID_SERIAL}==\"${serial}\", SYMLINK+=\"harddisk%n\""
    echo
    
  ) > /etc/udev/rules.d/70-Smoothwall-custom-disk.rules

  mv /etc/udev/rules.d/70-persistent-net.rules /etc/udev/rules.d/70-Smoothwall-custom-NIC.rules

  echo "  Triggering udev and waiting for it to settle"
  /sbin/udevadm trigger --subsystem-match=net
  /sbin/udevadm trigger --subsystem-match=block
  /sbin/udevadm settle

