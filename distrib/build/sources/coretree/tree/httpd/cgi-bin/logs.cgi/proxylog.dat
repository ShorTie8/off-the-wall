#!/usr/bin/perl
#
# SmoothWall CGIs
#
# This code is distributed under the terms of the GPL
#
# (c) The SmoothWall Team

use lib "/usr/lib/smoothwall";
use header qw( :standard );

my %cgiparams;
my %ips;
my %save;
my %selected;
my %checked;
my $errormessage;
my @log;

my @shortmonths = ( 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug',
	'Sep', 'Oct', 'Nov', 'Dec' );
my @longmonths = ( $tr{'january'}, $tr{'february'}, $tr{'march'},
	$tr{'april'}, $tr{'may'}, $tr{'june'}, $tr{'july'}, $tr{'august'},
	$tr{'september'}, $tr{'october'}, $tr{'november'},
	$tr{'december'} );

my @now = localtime(time);

$cgiparams{'DAY'} = $now[3]; 
$cgiparams{'MONTH'} = $now[4];
$cgiparams{'SOURCE_IP'} = 'ALL';
$cgiparams{'FILTER'} = "[.](gif|jpeg|jpg|png|css|js)\$";
$cgiparams{'ENABLE_FILTER'} = 'off';

&getcgihash(\%cgiparams);

if ($cgiparams{'ACTION'} eq '')
{
	$cgiparams{'ENABLE_FILTER'} = 'on';
}

if ($cgiparams{'ACTION'} eq $tr{'restore defaults'})
{
	$cgiparams{'FILTER'} = "[.](gif|jpeg|jpg|png|css|js)\$";
	$cgiparams{'ENABLE_FILTER'} = 'off'; 
}

$save{'FILTER'} = $cgiparams{'FILTER'};
$save{'ENABLE_FILTER'} = $cgiparams{'ENABLE_FILTER'};

&writehash("${swroot}/proxy/viewersettings", \%save);
&readhash("${swroot}/proxy/viewersettings", \%save);

my $start = -1;
if ($ENV{'QUERY_STRING'} && $cgiparams{'ACTION'} ne $tr{'update'})
{
	my @temp = split(',',$ENV{'QUERY_STRING'});
 	$start = $temp[0];
 	$cgiparams{'MONTH'} = $temp[1];
 	$cgiparams{'DAY'} = $temp[2];  
	$cgiparams{'SOURCE_IP'} = $temp[3];
}

if (!($cgiparams{'MONTH'} =~ /^(0|1|2|3|4|5|6|7|8|9|10|11)$/) ||
        !($cgiparams{'DAY'} =~ /^(1|2|3|4|5|6|7|8|9|10|11|12|13|14|15|16|17|18|19|20|21|22|23|24|25|26|27|28|29|30|31)$/))
{
        $cgiparams{'DAY'} = $now[3];
        $cgiparams{'MONTH'} = $now[4];
}

my $monthstr = $shortmonths[$cgiparams{'MONTH'}];
my $day = $cgiparams{'DAY'};
my $daystr;
if ($day <= 9) {
	$daystr = " $day"; }
else {
	$daystr = $day; }

if ($daystr < 10)
{
	$daystr++;
	$daystr--;
	$daystr="0$daystr";
}
my $search_date = "$daystr/$monthstr";
	
my $lines = 0;

my $filter;

if ($cgiparams{'ENABLE_FILTER'} eq 'on') {
	$filter = $cgiparams{'FILTER'}; }
else {
	$filter = ''; }
my $sourceip = $cgiparams{'SOURCE_IP'};
my $sourceall;
if ($cgiparams{'SOURCE_IP'} eq 'ALL') {
	$sourceall = 1; }
else {
	$sourceall = 0; }

my $thiscode = '$temp =~ /$filter/;';
eval($thiscode);
if ($@ ne '')
{
	$errormessage = $tr{'bad ignore filter'}.$@;
	$filter = '';
}
else
{
	open (FILE, '/var/log/squid/access.log');
	while (<FILE>)
	{
		my ($ip,$fe,$fi,$datetime,$fo,$type,$url,$fod) = split;
		$ips{$ip}++;
		if ((m|$search_date|) && !($url =~ /$filter/) &&
			((($ip eq $sourceip) || $sourceall)))
		{	
			my ($date,$hour,$minute,$second)=split(/:/,$datetime);
			my ($header,$urlsnip,$data)=split('/+',$url);
 			$log[$lines] = "$hour:$minute:$second $ip $url";
			$lines++;
		}
	}	
	close (FILE);
}
if ($cgiparams{'ACTION'} eq $tr{'export'})
{
	print "Content-type: text/plain\n\n";
	print "SmoothWall proxy log\r\n";
	print "Date: $cgiparams{'DAY'} $longmonths[$cgiparams{'MONTH'}]\r\n"; 
	print "Source IP: $cgiparams{'SOURCE_IP'}\r\n";
	if ($cgiparams{'ENABLE_FILTER'} eq 'on') {
		print "Ignore filter: $cgiparams{'FILTER'}\r\n"; }
	print "\r\n";

	foreach $_ (@log) {
		print "$_\n"; }

	exit;
}

$selected{'SOURCE_IP'}{$cgiparams{'SOURCE_IP'}} = 'SELECTED';

$checked{'ENABLE_FILTER'}{'off'} = '';
$checked{'ENABLE_FILTER'}{'on'} = '';
$checked{'ENABLE_FILTER'}{$cgiparams{'ENABLE_FILTER'}} = 'CHECKED';

&showhttpheaders();

&openpage($tr{'proxy log viewer'}, 1, '', 'logs');

&openbigbox('100%', 'LEFT');

&alertbox($errormessage);

&openbox($tr{'settingsc'});

print <<END
<FORM ACTION='/cgi-bin/logs.cgi/proxylog.dat' METHOD='POST'>
<TABLE WIDTH='100%'>
<TR>
	<TD WIDTH='15%' CLASS='base'>$tr{'month'}</TD>
	<TD WIDTH='20%'>
	<SELECT NAME='MONTH'>
END
;
my $month;
for ($month = 0; $month < 12; $month++)
{
	print "\t<OPTION ";
	if ($month == $cgiparams{'MONTH'}) {
		print 'SELECTED '; }
	print "VALUE='$month'>$longmonths[$month]\n";
}
print <<END
	</SELECT>
	</TD>
	<TD WIDTH='15%' CLASS='base'>$tr{'day'}</TD>
	<TD WIDTH='20%'>
	<SELECT NAME='DAY'>
END
;
for ($day = 1; $day <= 31; $day++) 
{
	print "\t<OPTION ";
	if ($day == $cgiparams{'DAY'}) {
		print 'SELECTED '; }
	print "VALUE='$day'>$day\n";
}
print <<END
	</SELECT>
	</TD>
	<TD CLASS='15%' CLASS='base'>$tr{'source ipc'}</TD>
	<TD CLASS='15%'>
	<SELECT NAME='SOURCE_IP'>
	<OPTION VALUE='ALL' $selected{'SOURCE_IP'}{'ALL'}>$tr{'caps all'}
END
;
my $ip;
foreach $ip (keys %ips) {
	print "<OPTION VALUE='$ip' $selected{'SOURCE_IP'}{$ip}>$ip\n"; }
print <<END
	</SELECT>
	</TD>
</TR>
<TR>
	<TD CLASS='base'>$tr{'ignore filterc'}</TD>
	<TD COLSPAN='3'><INPUT TYPE='text' NAME='FILTER' VALUE='$cgiparams{'FILTER'}' SIZE='40'></TD>
	<TD CLASS='base'>$tr{'enable ignore filterc'}</TD>
	<TD><INPUT TYPE='checkbox' NAME='ENABLE_FILTER' VALUE='on' $checked{'ENABLE_FILTER'}{'on'}></TD>
</TR>
</TABLE>
<DIV ALIGN='CENTER'>
<TABLE WIDTH='50%'>
<TR>
	<TD ALIGN='CENTER'><INPUT TYPE='submit' NAME='ACTION' VALUE='$tr{'restore defaults'}'></TD>
	<TD ALIGN='CENTER'><INPUT TYPE='submit' NAME='ACTION' VALUE='$tr{'update'}'></TD>
	<TD ALIGN='CENTER'><INPUT TYPE='submit' NAME='ACTION' VALUE='$tr{'export'}'></TD>
</TR>
</TABLE>
</FORM>
END
;

&closebox();

&openbox($tr{'logc'});
 
if ($start == -1) {
        $start = $lines - $viewsize; }
if ($start >= $lines - $viewsize) { $start = $lines - $viewsize; };
if ($start < 0) { $start = 0; }

my $prev = $start - $viewsize;
my $next = $start + $viewsize;

if ($prev < 0) { $prev = 0; }
if ($next >= $lines) { $next = -1 }
if ($start == 0) { $prev = -1; }
my @slice = splice(@log, $start, $viewsize);

print <<END
<table class='centered'>
<tr>
<td style='text-align: center;'>
END
;

if ($next != -1) {
	print "<a href='/cgi-bin/logs.cgi/proxylog.dat?$next,$cgiparams{'MONTH'},$cgiparams{'DAY'},$cgiparams{'SOURCE_IP'}'>&lt;</a> "; }
else {
	print "&lt; "; }

for ( my $i = ($lines-$viewsize) ; $i > 0 ; $i -= $viewsize ){
	my $link;
	if ( $i == ($lines-$viewsize) ){
		# first
		$link = "Sm";
	} elsif ( $i-$viewsize <= 0 ){
		# last
		$link = "th";
	} else {
		# and always
		$link = "o"
	}

	if ( $i == $start ){
		print "<a class='activemenu' href='/cgi-bin/log.cgi/proxylog.dat?$i,$cgiparams{'MONTH'},$cgiparams{'DAY'},$cgiparams{'SOURCE_IP'}''>$link</a>"
	} else {
		print "<a href='/cgi-bin/logs.cgi/proxylog.dat?$i,$cgiparams{'MONTH'},$cgiparams{'DAY'},$cgiparams{'SOURCE_IP'}''>$link</a>"
	}
}

if ($prev != -1) {
	print " <a href='/cgi-bin/logs.cgi/proxylog.dat?$prev,$cgiparams{'MONTH'},$cgiparams{'DAY'},$cgiparams{'SOURCE_IP'}'>&gt;</a>"; }
else {
	print " &gt;"; }

print <<END
</td>
</tr>
</table>
END
;

print <<END
<table class='centered'>
<tr>
	<th style='width: 10%;'>$tr{'time'}</th>
	<th style='width: 15%;'>$tr{'source ip'}</th>
	<th style='width: 75%;'>$tr{'website'}</th>
</tr>
END
;

$lines = 0;
foreach $_ (@slice)
{
	if ($lines % 2) {
		print "<TR BGCOLOR='$table1colour'>\n"; }
	else {
		print "<TR BGCOLOR='$table2colour'>\n"; }
	my ($time,$ip,$url) = split;
	$url =~ /(^.{0,60})/;
	my $part = $1;
	unless (length($part) < 60) { $part = "${part}..."; }  
	print <<END
	<TD ALIGN='CENTER'>$time</TD>
	<TD ALIGN='CENTER'>$ip</TD>
	<TD ALIGN='LEFT'><A HREF='$url' TITLE='$url' TARGET='_new'>$part</A></TD>
</TR>
END
	;
	$lines++;
}

print "</table>";

&closebox();

&alertbox('add','add');

&closebigbox();

&closepage();
