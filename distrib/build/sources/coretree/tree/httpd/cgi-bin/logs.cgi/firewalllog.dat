#!/usr/bin/perl
#
# SmoothWall CGIs
#
# This code is distributed under the terms of the GPL
#
# (c) The SmoothWall Team

#Aug 28 14:54:30 shite kernel: IN=ppp0 OUT= MAC= SRC=213.48.150.1
#DST=213.208.115.234 LEN=110 TOS=0x00 PREC=0x00 TTL=60 ID=30699 DF PROTO=TCP
#SPT=6667 DPT=62593 WINDOW=2505 RES=0x00 ACK PSH URGP=0  

require '/var/smoothwall/header.pl';

if ($ENV{'QUERY_STRING'})
{
	$_ = $ENV{'QUERY_STRING'};
	my $action;
	$_ =~ s/\+/ /g;
	my @temp = split(/\&/);
	foreach $_ (@temp)
	{
		($var, $val) = split(/\=/);
		if ($var eq 'ACTION') {
			$action = $val; }
	}

	if ($action eq $tr{'add to ip block'})
	{
		print "Status: 302 Moved\n";
		print "Location: /cgi-bin/ipblock.cgi?$ENV{'QUERY_STRING'}\n\n";
		exit 0;
	}
	if ($action eq $tr{'lookup'})
	{
		print "Status: 302 Moved\n";
		print "Location: /cgi-bin/ipinfo.cgi?$ENV{'QUERY_STRING'}\n\n";
		exit 0;
	}
}

my %cgiparams;
my $errormessage;

my @shortmonths = ( 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug',
	'Sep', 'Oct', 'Nov', 'Dec' );
my @longmonths = ( $tr{'january'}, $tr{'february'}, $tr{'march'},
	$tr{'april'}, $tr{'may'}, $tr{'june'}, $tr{'july'}, $tr{'august'},
	$tr{'september'}, $tr{'october'}, $tr{'november'},
	$tr{'december'} );

my @now = localtime(time);

my %hithash;

$cgiparams{'DAY'} = $now[3];
$cgiparams{'MONTH'} = $now[4];

&getcgihash(\%cgiparams);

my $start = -1;
if ($ENV{'QUERY_STRING'} && $cgiparams{'ACTION'} ne $tr{'update'})
{
	my @temp = split(',',$ENV{'QUERY_STRING'});
	$start = $temp[0];
	$cgiparams{'MONTH'} = $temp[1];
	$cgiparams{'DAY'} = $temp[2];
}

if (!($cgiparams{'MONTH'} =~ /^(0|1|2|3|4|5|6|7|8|9|10|11)$/) ||
	!($cgiparams{'DAY'} =~ /^(1|2|3|4|5|6|7|8|9|10|11|12|13|14|15|16|17|18|19|20|21|22|23|24|25|26|27|28|29|30|31)$/))
{
	$cgiparams{'DAY'} = $now[3];
	$cgiparams{'MONTH'} = $now[4];
}

my $monthstr = $shortmonths[$cgiparams{'MONTH'}];
my $day = $cgiparams{'DAY'};
my $daystr;
if ($day <= 9) {
	$daystr = " $day"; }
else {
	$daystr = $day; }

open (FILE, '/var/log/messages');
my $lines = 0;
my @log;
while (<FILE>)
{
 	if (/(^${monthstr} ${daystr} ..:..:..) [\w\-]+ kernel: (.*)$/)
	{
		$packet = $2; $src = ''; $dst = '';
		if ($packet =~ /SRC\=([\d\.]+)/) { $src = $1; }
		if ($packet =~ /DST\=([\d\.]+)/) { $dst = $1; }
		if ($src && $dst)
		{
			$log[$lines] = $_;
			$lines++;
		}
	}
}
close (FILE);	

if ($cgiparams{'ACTION'} eq $tr{'export'})
{
	print "Content-type: text/plain\n\n";
	print "SmoothWall firewall log\r\n";
	print "Date: $cgiparams{'DAY'} $longmonths[$cgiparams{'MONTH'}]\r\n\r\n";

	foreach $_ (@log)
	{
		/(^${monthstr} ${daystr} ..:..:..) [\w\-]+ kernel: (.*)/;
		my $timestamp = $1; my $packet = $2;
		$timestamp =~ /... (..) (..:..:..)/;
		my $day = $1; my $time = $2;
		print "$time $packet\r\n";
	}
	exit 0;
}
	
&showhttpheaders();

&openpage($tr{'firewall log'}, 1, '', 'logs');

&openbigbox('100%', 'LEFT');

&alertbox($errormessage);

&openbox($tr{'settingsc'});

print <<END
<FORM METHOD='POST'>
<TABLE WIDTH='100%'>
<TR>
	<TD WIDTH='15%' CLASS='base'>$tr{'month'}</TD>
	<TD WIDTH='25%'>
	<SELECT NAME='MONTH'>
END
;
my $month;
for ($month = 0; $month < 12; $month++)
{
	print "\t<OPTION ";
	if ($month == $cgiparams{'MONTH'}) {
		print 'SELECTED '; }
	print "VALUE='$month'>$longmonths[$month]\n";
}
print <<END
	</SELECT>
	</TD>
	<TD WIDTH='15%' CLASS='base'>$tr{'day'}</TD>
	<TD WIDTH='25%'>
	<SELECT NAME='DAY'>
END
;
for ($day = 1; $day <= 31; $day++) 
{
	print "\t<OPTION ";
	if ($day == $cgiparams{'DAY'}) {
		print 'SELECTED '; }
	print "VALUE='$day'>$day\n";
}
print <<END
</SELECT>
</TD>
<TD WIDTH='10%' ALIGN='CENTER'><INPUT TYPE='submit' NAME='ACTION' VALUE='$tr{'update'}'></TD>
<TD WIDTH='10%' ALIGN='CENTER'><INPUT TYPE='submit' NAME='ACTION' VALUE='$tr{'export'}'></TD>
</TR>
</TABLE>
</FORM>
END
;

&closebox();

&openbox($tr{'firewall log2'});
print <<END
<FORM METHOD='GET'>
<TABLE WIDTH='100%'>
<TR>
	<TD WIDTH='10%' ALIGN='CENTER' CLASS='boldbase'><B>$tr{'time'}</B></TD>
	<TD WIDTH='10%' ALIGN='CENTER' CLASS='boldbase'><B>$tr{'in'}</B></TD>
	<TD WIDTH='10%' ALIGN='CENTER' CLASS='boldbase'><B>$tr{'out'}</B></TD>
	<TD WIDTH='10%' ALIGN='CENTER' CLASS='boldbase'><B>$tr{'protocol'}</B></TD>
	<TD WIDTH='20%' ALIGN='CENTER' CLASS='boldbase'><B>$tr{'source'}</B></TD>
	<TD WIDTH='10%' ALIGN='CENTER' CLASS='boldbase'><B>$tr{'src port'}</B></TD>
	<TD WIDTH='20%' ALIGN='CENTER' CLASS='boldbase'><B>$tr{'destination'}</B></TD>
	<TD WIDTH='10%' ALIGN='CENTER' CLASS='boldbase'><B>$tr{'dst port'}</B></TD>
</TR>
<TR>
END
;

if ($start == -1) {
        $start = $lines - $viewsize; }
if ($start >= $lines - $viewsize) { $start = $lines - $viewsize; };
if ($start < 0) { $start = 0; }

my $prev = $start - $viewsize;
my $next = $start + $viewsize;

if ($prev < 0) { $prev = 0; }
if ($next >= $lines) { $next = -1 }
if ($start == 0) { $prev = -1; }

$lines = 0;
my @slice = splice(@log, $start, $viewsize);
foreach $_ (@slice)
{
	my $in = '-'; my $out = '-';
	my $srcaddr = ''; my $dstaddr = '';
	my $protostr = '';
	my $srcport = ''; my $dstport = '';

	/(^${monthstr} ${daystr} ..:..:..) [\w\-]+ kernel: (.*)/;
	my $timestamp = $1; my $packet = $2;
	$timestamp =~ /... (..) (..:..:..)/;
	my $day = $1; my $time = $2;

	if ($packet =~ /IN\=(\w+)/) { $in = $1; }
	if ($packet =~ /OUT\=(\w+)/) { $out = $1; }
	if ($packet =~ /SRC\=([\d\.]+)/) { $srcaddr = $1; }
	if ($packet =~ /DST\=([\d\.]+)/) { $dstaddr = $1; }
	if ($packet =~ /PROTO\=(\w+)/) { $protostr = $1; }
	my $protostrlc = lc($protostr);
	if ($packet =~ /SPT\=(\d+)/) { $srcport = $1; }
	if ($packet =~ /DPT\=(\d+)/) { $dstport = $1; }
	my $servi = uc(getservbyport($srcport, $protostrlc));
	my ($srcportstr,$dstportstr);
	if ($servi ne '' && $srcport < 1024) {
		$srcportstr = "$srcport($servi)"; }
	else {
		$srcportstr = $srcport; }
	$servi = uc(getservbyport($dstport, $protostrlc));
	if ($servi ne '' && $dstport < 1024) {    
		$dstportstr = "$dstport($servi)"; }
	else {
		$dstportstr = $dstport; }
	if ($lines % 2) {
		print "<TR BGCOLOR='$table1colour'>\n"; }
	else {
		print "<TR BGCOLOR='$table2colour'>\n"; }
	print <<END
	<TD ALIGN='CENTER'>$time</TD>
	<TD ALIGN='CENTER'>$in</TD>
	<TD ALIGN='CENTER'>$out</TD>
	<TD ALIGN='CENTER'>$protostr</TD>
        <TD ALIGN='CENTER'>
	<TABLE WIDTH='100%' CELLPADDING='0' CELLSPACING='0'><TR>
	<TD><INPUT TYPE='checkbox' NAME='ip' VALUE='$srcaddr'></TD>
	<TD ALIGN='CENTER'>$srcaddr</TD>
	</TR></TABLE>
	</TD>
	<TD ALIGN='CENTER'>$srcportstr</TD>
        <TD ALIGN='CENTER'>
	<TABLE WIDTH='100%' CELLPADDING='0' CELLSPACING='0'><TR>
	<TD><INPUT TYPE='checkbox' NAME='ip' VALUE='$dstaddr'></TD>
	<TD ALIGN='CENTER'>$dstaddr</TD>
	</TR></TABLE>
	</TD>
	<TD ALIGN='CENTER'>$dstportstr</TD>
</TR>
END
	;
	$lines++;
}

print <<END
</TABLE>
<DIV ALIGN='CENTER'>
<TABLE WIDTH='50%'>
<TR>
<TD WIDTH='50%' ALIGN='CENTER'><INPUT TYPE='submit' NAME='ACTION' VALUE='$tr{'lookup'}'></TD>
<TD WIDTH='50%' ALIGN='CENTER'><INPUT TYPE='submit' NAME='ACTION' VALUE='$tr{'add to ip block'}'></TD>
</TR>
</TABLE>
</DIV>
</FORM>
<TABLE WIDTH='100%'>
<TR>
END
;

print "<TD ALIGN='CENTER' WIDTH='50%'>";
if ($prev != -1) {
	print "<A HREF='/cgi-bin/logs.cgi/firewalllog.dat?$prev,$cgiparams{'MONTH'},$cgiparams{'DAY'}'>$tr{'older'}</A>"; }
else {
	print "$tr{'older'}"; }
print "</TD>\n";

print "<TD ALIGN='CENTER' WIDTH='50%'>";
if ($next != -1) {
	print "<A HREF='/cgi-bin/logs.cgi/firewalllog.dat?$next,$cgiparams{'MONTH'},$cgiparams{'DAY'}'>$tr{'newer'}</A>"; }
else {
	print "$tr{'newer'}"; }
print "</TD>\n";

print <<END
</TR>
</TABLE>
END
;

&closebox();

&alertbox('add','add');

&closebigbox();

&closepage();

sub gethithash
{
	my $line = $_[0];
	my $hash = $_[1];
	my $name; my $value;

	my @line = split(/ /, $line);
	foreach (@line)
	{
		($name, $value) = split(/\=/);
		$hash->{$name} = $value;
	}
}
