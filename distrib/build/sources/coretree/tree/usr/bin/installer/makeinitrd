#!/bin/sh
#
# Copyright 2004-2010 SmoothWall Ltd

cp -f /usr/lib/installer/basicrootfs.gz /root/
/usr/bin/gzip -d /root/basicrootfs.gz

. /var/smoothwall/main/kernel

for KERNEL_TYPE in runtime runtimebig; do

if [ -e /lib/modules/${CURRENT}-${KERNEL_TYPE} ]; then

(cd /mnt/initrd; cpio -H newc -iv < /root/basicrootfs)

rm -rf /mnt/initrd/lib/modules
cp --parents -aR /lib/modules/${CURRENT}-${KERNEL_TYPE}/modules.* /mnt/initrd
cp --parents -aR /lib/modules/${CURRENT}-${KERNEL_TYPE}/kernel /mnt/initrd
cp --parents -aR /lib/firmware /mnt/initrd
rm -rf /mnt/initrd/lib/modules/${CURRENT}-${KERNEL_TYPE}/kernel/drivers/net
cp -aR /usr/bin/installer/init /mnt/initrd/init

(cd /mnt/initrd; find . -print | cpio -H newc -ov > /root/initrd-${CURRENT}-${KERNEL_TYPE})

/usr/bin/gzip /root/initrd-${CURRENT}-${KERNEL_TYPE}
mv -f /root/initrd-${CURRENT}-${KERNEL_TYPE}.gz /boot

rm -rf /mnt/initrd/*

fi

done

rm -f /root/basicrootfs

exit 0;
