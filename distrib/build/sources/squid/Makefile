# SmoothWall Build system.
#
# (c) SmoothWall Ltd 2005
#
# This code is distributed under the terms of the GPL v2.

include ../Makefile.conf
include ../Makefile.versions

PACKAGE = squid
VERSION = 3.5.6

BASE_URL = http://www.squid-cache.org/Versions/v3/3.5/

CONFIG_OPTS += --enable-storeio="aufs,diskd,ufs" --enable-linux-netfilter \
	      --enable-removal-policies="heap,lru" --enable-delay-pools \
	      --localstatedir=/var --with-dl --with-openssl \
	      --enable-http-violations --enable-icap-client \
	      --with-large-files --with-libcap --disable-ipv6

INSTALL_LANGUAGES = English

CONFIGURE = yes

configure: patch
	@/bin/sh -c "ulimit -n 8192; cd $(DIR); ./configure $(CONFIG_OPTS) --prefix=/$(PKG_DIR)"


INSTALL = yes

install: compile
	mkdir -p $(PKG_ROOT)
	+$(MAKE) -C $(COMPILE_DIR) DESTDIR=$(PKG_ROOT) install
	mkdir -p $(PKG_ROOT)/var/smoothwall/proxy
	touch $(PKG_ROOT)/var/smoothwall/proxy/squid.conf
	chown nobody:nobody $(PKG_ROOT)/var/smoothwall/proxy/squid.conf
	chown 664 $(PKG_ROOT)/var/smoothwall/proxy/squid.conf
	ln -s $(PKG_ROOT)/usr/etc/squid.conf /var/smoothwall/proxy/squid.conf


BUILDTARBALL = yes

SQUID_BITS = ./usr/bin/ ./usr/libexec/ ./usr/sbin/squid \
             ./usr/etc/mime.conf ./usr/share/ ./var/smoothwall/proxy/squid.conf

$(TARGET_DIR)/smoothwall-$(PACKAGE).tar.gz: install
	@tar -zcvf $(TARGET_DIR)/smoothwall-$(PACKAGE).tar.gz -C $(PKG_ROOT) $(SQUID_BITS)
	@tar -xvf $(TARGET_DIR)/smoothwall-$(PACKAGE).tar.gz -C /

include ../Makefile.rules
