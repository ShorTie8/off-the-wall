#!/bin/bash

CLS="\033[0;0f\033[2J"
BO="\033[1m"
UL="\033[4m"
BOUL="\033[1;4m"
NO="\033[0m"

/sbin/depmod -a

echo "Loading, please wait..."

[ -d /dev ] || mkdir -m 0755 /dev
[ -d /root ] || mkdir -m 0700 /root
[ -d /sys ] || mkdir /sys
[ -d /proc ] || mkdir /proc
[ -d /tmp ] || mkdir -m 0777 /tmp
[ -d /run ] || mkdir -m 0755 /run
[ -d /var/lock ] || mkdir -p -m 755 /var/lock

# Mount proc, sys, dev
echo "Mounting /proc, /sys"
/bin/mount -t proc proc /proc
/bin/mount -t sysfs sysfs /sys

echo "Mounting devtmpfs"
/bin/mount -t devtmpfs devtmpfs /dev
/bin/mkdir -p /dev/pts
/bin/mount -t devpts -o gid=5,mode=620 devpts /dev/pts


# Populating dev
echo "If you added one or more NICs to an existing system, startup may"
echo "  hang here for a minute waiting for udev. Please be patient."
/sbin/udevd --daemon
/sbin/udevadm trigger
/sbin/udevadm settle

# Some drivers may not notify udev of new disks, so wait up to 30s for
#   the sda4 partition node to become available. As soon as it appears,
#   make the symlinks--if needed--and bust out of gaol.
# Fail if it takes longer than 15s.
typeset -i i; i=0
while true; do
  if [ $i -eq 10 ]; then
    echo "Waiting for storage to become ready..."
  fi
  # When the partition node is available but the harddisk symlink isn't,
  #   make all the harddisk symlinks and bust out. We'll assume that udev
  #   doesn't know about the discovered drive.
  if [ -e "/dev/sda4" ]; then
    # Wait a half-second, Justin Case; maybe udev'll get to it.
    sleep .5
    if [ ! -e "/dev/harddisk4" ]; then
      for NODE in /dev/sda*; do
        ln -s $NODE ${NODE/sda/harddisk} >/dev/null 2>&1
      done
    fi
    # Either way, the symlink(s) now exist.
    break;
  fi

  sleep .1
  i=i+1
  # 15 seconds should be *plenty* long enough for SCSI devices to come to life in a smoothie.
  if [ $i -eq 150 ]; then
    echo "Could not find root storage device. Cannot boot!"
    sleep 2
    exit 1
  fi
done
unset i NODE

# Load any modules explicitly required
test -e /etc/modules && egrep -v "^$|^#" /etc/modules | while read a; do modprobe $a; done

# Switch to hard drive and start the system
/bin/mount /harddisk -o ro

# Stop udevd; missed events will be caught later
udevadm control --exit

echo "1 4 1 7" >/proc/sys/kernel/printk

/bin/mount -n --move /dev /harddisk/dev

PNR="/etc/udev/rules.d/70-persistent-net.rules"
if [ -f "$PNR" ]; then
  cp "$PNR" /harddisk/dev
fi

/usr/lib/klibc/bin/nuke /dev
/bin/ln -s /harddisk/dev /dev

/bin/mount -n --move /sys /harddisk/sys
/bin/mount -n --move /proc /harddisk/proc

exec /usr/lib/klibc/bin/run-init /harddisk /sbin/init </harddisk/dev/console >/harddisk/dev/console 2>&1
